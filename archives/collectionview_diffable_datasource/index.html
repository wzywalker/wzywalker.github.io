<!DOCTYPE HTML>
<html lang="english">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Maverick,AlanDecode,Galileo,blog" />
    <meta name="generator" content="Maverick 1.2.1" />
    <meta name="template" content="Prism" />
    <link rel="alternate" type="application/rss+xml" title="walker's code blog &raquo; RSS 2.0" href="/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="walker's code blog &raquo; ATOM 1.0" href="/feed/atom/index.xml" />
    <link rel="stylesheet" href="/assets/prism-b9d78ff38a.css">
    <link rel="stylesheet" href="/assets/ExSearch/ExSearch-182e5a8869.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "/b098f530e4b4a4a690a595806babc6a7.json"
        }

    </script>
    
<title>Collection View With Diffable Datasource - walker's code blog</title>
<meta name="author" content="walker" />
<meta name="description" content="è¿™ç¯‡æ–‡ç« æœ‰" />
<meta property="og:title" content="Collection View With Diffable Datasource - walker's code blog" />
<meta property="og:description" content="è¿™ç¯‡æ–‡ç« æœ‰" />
<meta property="og:site_name" content="walker's code blog" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/archives/collectionview_diffable_datasource/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2022-09-09T23:57:00-00.00" />
<meta name="twitter:title" content="Collection View With Diffable Datasource - walker's code blog" />
<meta name="twitter:description" content="è¿™ç¯‡æ–‡ç« æœ‰" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
</head>

<body>
    <div class="container prism-container">
        <header class="prism-header" id="prism__header">
            <h1 class="text-uppercase brand"><a class="no-link" href="/" target="_self">walker's code blog</a></h1>
            <p>coder, reader</p>
            <nav class="prism-nav"><ul><li><a class="no-link text-uppercase " href="/" target="_self">Home</a></li><li><a class="no-link text-uppercase " href="/archives/" target="_self">Archives</a></li><li><a class="no-link text-uppercase " href="/about/" target="_self">About</a></li><li><a href="#" target="_self" class="search-form-input no-link text-uppercase">Search</a></li></ul></nav>
        </header>
        <div class="prism-wrapper" id="prism__wrapper">
            
<main>
    <section class="prism-section row" id="prism__content">
        <article class="yue col-md-8 offset-md-2">
            <h1 class="prism-post-title">Collection View With Diffable Datasource</h1>
            <div class="prism-post-time">
                <time class="text-uppercase">
                    September 09 2022
                </time>
            </div>
            <div class="prism-content-body">
                <p>è¿™ç¯‡æ–‡ç« æœ‰</p><ul>
<li>collection viewè‡ªå®šä¹‰å¸ƒå±€çš„ä¸€äº›å¿ƒå¾—ä½“ä¼šå’ŒæŸ¥é˜…æ–‡æ¡£æ—¶çš„ä¸€äº›ç¬”è®°</li>
<li>Compositional layoutç¬”è®° ï¼ˆå°‘é‡ï¼‰</li>
<li>diffable datasourceç¬”è®°</li>
</ul>
<h1>Compositional Layout</h1>
<ul>
<li>Group å®½é«˜ç»™å¤Ÿï¼ˆæˆ–estimateï¼‰ï¼ŒItemå›ºå®šå¤§å°ï¼Œå°±æˆäº†ä¸€ä¸ªFlowLayout</li>
<li>è®¾å®šsectionå‚ç›´æ–¹å‘è¡Œä¸ºä¸ºæ»šåŠ¨(åˆ†é¡µï¼Œé è¾¹ç­‰ï¼‰ï¼Œåˆ™ä¸ä¼šæŠ˜è¡Œ<ul>
<li><code>.continuousGroupLeadingBoundary</code> çš„æ„æ€æ˜¯å¦‚æœä¸€è¡Œæ‘†ä¸ä¸‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¼šæŠ˜è¡Œï¼Œè¿™ä¸€è¡Œåé¢å°±ä¼šå‰©ä¸‹ç©ºç™½ï¼Œå½“ä½ åšæˆcontinousåï¼Œä¸‹ä¸€ä¸ªå…ƒç´ ä¹Ÿä¼šæ’åœ¨ç©ºç™½åï¼Œè€Œä¸æ˜¯ç›´æ¥å°±æ¥åœ¨åé¢äº†</li>
<li><code>.paging</code>å’Œ<code>.groupPageing</code>çš„åŒºåˆ«åˆ™æ˜¯ä¸€æ¬¡æ»šåŠ¨ä¸€é¡µè¿˜æ˜¯ä¸€ä¸ªgroup</li>
</ul>
</li>
</ul>
<h1>Diffable Data Sources</h1>
<ul>
<li>A <em>diffable data source</em> stores a list of section and item <em>identifiers</em><ul>
<li>In contrast, a custom data source that conforms to <a href="https://developer.apple.com/documentation/uikit/uicollectionviewdatasource"><code>UICollectionViewDataSource</code></a> uses <em>indices</em> and <em>index paths</em>, which arenâ€™t stable.<ul>
<li>They represent the <strong>location</strong> of sections and items, which can change as the data source adds, removes, and rearranges the contents of a collection view.</li>
<li>ç›¸åDiffable Data Sourceå´èƒ½æ ¹æ®identifierè¿½æº¯åˆ°å…¶location</li>
</ul>
</li>
</ul>
</li>
<li>To use a value as an identifier, its data type must conform to the <a href="https://developer.apple.com/documentation/swift/hashable"><code>Hashable</code></a> protocol.<ul>
<li>Hashingèƒ½è®©é›†åˆæˆä¸ºâ€œé”®â€ï¼Œæä¾›å¿«é€Ÿlookupèƒ½åŠ›<ul>
<li>æ¯”å¦‚set, dictionary, snapshot</li>
</ul>
</li>
<li>can determine the differences between its <strong>current</strong> snapshot and <strong>another</strong> snapshot.</li>
</ul>
</li>
</ul>
<h3>Define the Diffable Data Source</h3>
<div class="highlight"><pre><span></span><span class="p">@</span><span class="n">preconcurrency</span> <span class="p">@</span><span class="n">MainActor</span> <span class="kd">class</span> <span class="bp">UICollectionViewDiffableDataSource</span><span class="p">&lt;</span><span class="n">SectionIdentifierType</span><span class="p">,</span> <span class="n">ItemIdentifierType</span><span class="p">&gt;</span> <span class="p">:</span> <span class="bp">NSObject</span> <span class="k">where</span> <span class="n">SectionIdentifierType</span> <span class="p">:</span> <span class="nb">Hashable</span><span class="p">,</span> <span class="n">SectionIdentifierType</span> <span class="p">:</span> <span class="n">Sendable</span><span class="p">,</span> <span class="n">ItemIdentifierType</span> <span class="p">:</span> <span class="nb">Hashable</span><span class="p">,</span> <span class="n">ItemIdentifierType</span> <span class="p">:</span> <span class="n">Sendable</span>

<span class="c1">// å£°æ˜ç¤ºä¾‹</span>
<span class="kd">private</span> <span class="kd">var</span> <span class="nv">recipeListDataSource</span><span class="p">:</span> <span class="bp">UICollectionViewDiffableDataSource</span><span class="p">&lt;</span><span class="n">RecipeListSection</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">.</span><span class="n">ID</span><span class="p">&gt;</span><span class="o">!</span>

<span class="kd">private</span> <span class="kd">enum</span> <span class="nc">RecipeListSection</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">main</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Recipe</span><span class="p">:</span> <span class="n">Identifiable</span><span class="p">,</span> <span class="n">Codable</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">title</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">var</span> <span class="nv">prepTime</span><span class="p">:</span> <span class="nb">Int</span>   <span class="c1">// In seconds.</span>
    <span class="kd">var</span> <span class="nv">cookTime</span><span class="p">:</span> <span class="nb">Int</span>   <span class="c1">// In seconds.</span>
    <span class="kd">var</span> <span class="nv">servings</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">var</span> <span class="nv">ingredients</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">var</span> <span class="nv">directions</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">var</span> <span class="nv">isFavorite</span><span class="p">:</span> <span class="nb">Bool</span>
    <span class="kd">var</span> <span class="nv">collections</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span>
    <span class="n">fileprivate</span> <span class="kd">var</span> <span class="nv">addedOn</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()</span>
    <span class="n">fileprivate</span> <span class="kd">var</span> <span class="nv">imageNames</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<ol>
<li>sectionæ˜¯æšä¸¾ï¼Œæšä¸¾å°±æ˜¯æ­£æ•´æ•°</li>
<li>Recipe conforming to <code>Identifiable</code>ï¼Œautomatically exposes the associated type <a href="https://developer.apple.com/documentation/swift/identifiable/id-swift.associatedtype"><code>ID</code></a></li>
<li>æ•´ä¸ª<code>Recipe</code>ç»“æ„ä½“ä¸å¿…æ˜¯<code>Hashable</code>çš„ï¼Œå› ä¸ºå­˜åœ¨Datasourceå’ŒSnapshoté‡Œçš„ä»…ä»…åªæ˜¯<code>identifiers</code><ol>
<li>Using the <code>Recipe.ID</code> as the item identifier type for the <code>recipeListDataSource</code> means that the <strong>data source</strong>, and any <strong>snapshots</strong> applied to it, <strong>contains only</strong> <code>Recipe.ID</code> values and not the complete recipe data.</li>
</ol>
</li>
</ol>
<h3>Configure the Diffable Data Source</h3>
<div class="highlight"><pre><span></span><span class="c1">// Create a cell registration that the diffable data source will use.</span>
<span class="kd">let</span> <span class="nv">recipeCellRegistration</span> <span class="p">=</span> <span class="bp">UICollectionView</span><span class="p">.</span><span class="n">CellRegistration</span><span class="p">&lt;</span><span class="bp">UICollectionViewListCell</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">cell</span><span class="p">,</span> <span class="n">indexPath</span><span class="p">,</span> <span class="n">recipe</span> <span class="k">in</span>
    <span class="c1">// ä¼šå¸¦ç€cellå¯¹è±¡ï¼Œä½ç½®å’Œåº”çš„æ•°æ®æºæ•°æ®æ¥è¯·æ±‚é…ç½®å½“å‰cell </span>
    <span class="c1">// è¿™é‡Œè¿›è¡Œäº†ä¸¤ç§é…ç½®ï¼Œ</span>
    <span class="c1">// 1. ä¸€ç§æ˜¯å¯¹contentConfigurationè¿›è¡Œé…ç½®ï¼ˆåº”è¯¥å°±æ˜¯åŒ…äº†ä¸€å±‚ï¼Œæ²¡å¯¹cellæš´éœ²å‡ºæ¥çš„subviewç›´æ¥è¿›è¡Œè®¾ç½®ï¼‰</span>
    <span class="kd">var</span> <span class="nv">contentConfiguration</span> <span class="p">=</span> <span class="bp">UIListContentConfiguration</span><span class="p">.</span><span class="n">subtitleCell</span><span class="p">()</span>
    <span class="n">contentConfiguration</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">recipe</span><span class="p">.</span><span class="n">title</span>
    <span class="n">contentConfiguration</span><span class="p">.</span><span class="n">secondaryText</span> <span class="p">=</span> <span class="n">recipe</span><span class="p">.</span><span class="n">subtitle</span>
    <span class="n">contentConfiguration</span><span class="p">.</span><span class="n">image</span> <span class="p">=</span> <span class="n">recipe</span><span class="p">.</span><span class="n">smallImage</span>
    <span class="n">contentConfiguration</span><span class="p">.</span><span class="n">imageProperties</span><span class="p">.</span><span class="n">cornerRadius</span> <span class="p">=</span> <span class="mi">4</span>
    <span class="n">contentConfiguration</span><span class="p">.</span><span class="n">imageProperties</span><span class="p">.</span><span class="n">maximumSize</span> <span class="p">=</span> <span class="n">CGSize</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">cell</span><span class="p">.</span><span class="n">contentConfiguration</span> <span class="p">=</span> <span class="n">contentConfiguration</span>

    <span class="c1">// 2. è¿™é‡Œå°±æ˜¯ç›´æ¥å¯¹cellçš„subviewæ¥è¿›è¡Œè®¾ç½®äº†ï¼Œæ‰€ä»¥ç†è®ºä¸Šä¸Šä¸€èŠ‚çš„å†…å®¹åº”è¯¥ä¹Ÿå¯ä»¥ç›´æ¥å¯¹cellæ¥é…ç½®</span>
    <span class="k">if</span> <span class="n">recipe</span><span class="p">.</span><span class="n">isFavorite</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">image</span> <span class="p">=</span> <span class="bp">UIImage</span><span class="p">(</span><span class="n">systemName</span><span class="p">:</span> <span class="s">&quot;heart.fill&quot;</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">accessoryConfiguration</span> <span class="p">=</span> <span class="bp">UICellAccessory</span><span class="p">.</span><span class="n">CustomViewConfiguration</span><span class="p">(</span><span class="n">customView</span><span class="p">:</span> <span class="bp">UIImageView</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">image</span><span class="p">),</span> <span class="n">placement</span><span class="p">:</span> <span class="p">.</span><span class="n">trailing</span><span class="p">(</span><span class="n">displayed</span><span class="p">:</span> <span class="p">.</span><span class="n">always</span><span class="p">),</span> <span class="n">cell</span><span class="p">.</span><span class="n">accessories</span> <span class="p">=</span> <span class="p">[.</span><span class="n">customView</span><span class="p">(</span><span class="n">configuration</span><span class="p">:</span> <span class="n">accessoryConfiguration</span><span class="p">)]</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cell</span><span class="p">.</span><span class="n">accessories</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Create the diffable data source and its cell provider.</span>
<span class="n">recipeListDataSource</span> <span class="p">=</span> <span class="bp">UICollectionViewDiffableDataSource</span><span class="p">(</span><span class="n">collectionView</span><span class="p">:</span> <span class="n">collectionView</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">collectionView</span><span class="p">,</span> <span class="n">indexPath</span><span class="p">,</span> <span class="n">identifier</span> <span class="p">-&gt;</span> <span class="bp">UICollectionViewCell</span> <span class="k">in</span>
    <span class="c1">// `identifier` is an instance of `Recipe.ID`. Use it to</span>
    <span class="c1">// retrieve the recipe from the backing data store.</span>
    <span class="kd">let</span> <span class="nv">recipe</span> <span class="p">=</span> <span class="n">dataStore</span><span class="p">.</span><span class="n">recipe</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">identifier</span><span class="p">)</span><span class="o">!</span>
    <span class="c1">// è¿™é‡Œæ—¢æ˜¯ä¼ å…¥æ³¨å†Œcellçš„æ–¹æ³•çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯é‚£ä¸ªæ–¹æ³•çš„handleré‡Œä¸‰ä¸ªå‚æ•°çš„æ¥æº</span>
    <span class="k">return</span> <span class="n">collectionView</span><span class="p">.</span><span class="n">dequeueConfiguredReusableCell</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="n">recipeCellRegistration</span><span class="p">,</span> <span class="k">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">recipe</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<ul>
<li>The <code>configureDataSource()</code> method creates a cell <strong>registration</strong> and provides a handler closure that <strong>configures each cell</strong> with data from a recipe.</li>
</ul>
<h3>Load the Diffable Data Source with Identifiers</h3>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">func</span> <span class="nf">loadRecipeData</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Retrieve the list of recipe identifiers determined based on a</span>
    <span class="c1">// selected sidebar item such as All Recipes or Favorites.</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">recipeIds</span> <span class="p">=</span> <span class="n">recipeSplitViewController</span><span class="p">.</span><span class="n">selectedRecipes</span><span class="p">?.</span><span class="n">recipeIds</span><span class="p">()</span>
    <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

    <span class="c1">// Update the collection view by adding the recipe identifiers to</span>
    <span class="c1">// a new snapshot, and apply the snapshot to the diffable data source.</span>
    <span class="kd">var</span> <span class="nv">snapshot</span> <span class="p">=</span> <span class="bp">NSDiffableDataSourceSnapshot</span><span class="p">&lt;</span><span class="n">RecipeListSection</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">.</span><span class="n">ID</span><span class="p">&gt;()</span>
    <span class="n">snapshot</span><span class="p">.</span><span class="n">appendSections</span><span class="p">([.</span><span class="n">main</span><span class="p">])</span>
    <span class="n">snapshot</span><span class="p">.</span><span class="n">appendItems</span><span class="p">(</span><span class="n">recipeIds</span><span class="p">,</span> <span class="n">toSection</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">)</span>
    <span class="n">recipeListDataSource</span><span class="p">.</span><span class="n">applySnapshotUsingReloadData</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span> <span class="c1">// åˆå§‹åŒ–ç”¨è¿™ä¸ªï¼Œreloadä»£è¡¨å®Œå…¨é‡è®¾</span>
    <span class="c1">// æ›´æ–°çš„è¯ç”¨ apply(_:animatingDifferences:) è¿™æ ·æœ‰åŠ¨ç”»</span>
<span class="p">}</span>
</pre></div>
<h3>Insert, Delete, and Move Items</h3>
<ul>
<li>To <strong>handle changes</strong> to a data collection, the app <strong>creates a new snapshot</strong> that represents the current state of the data collection and <strong>applies</strong> it to the diffable data source.</li>
<li>The data source <strong>compares</strong> its current snapshot with the new snapshot to <strong>determine the changes</strong>.</li>
<li>Then it performs the necessary inserts, deletes, and moves into the collection view based on those changes.</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nv">snapshot</span> <span class="p">=</span> <span class="bp">NSDiffableDataSourceSnapshot</span><span class="p">&lt;</span><span class="n">RecipeListSection</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">.</span><span class="n">ID</span><span class="p">&gt;()</span>
<span class="n">snapshot</span><span class="p">.</span><span class="n">appendSections</span><span class="p">([.</span><span class="n">main</span><span class="p">])</span> <span class="c1">// sectionæ˜¯ç›´æ¥é‡å»ºçš„ï¼Œè€Œä¸æ˜¯ä»å“ªå»retrieveä¸€ä¸ª, å› ä¸ºå®ƒä»£è¡¨çš„æ˜¯IDï¼Œåªè¦å€¼ä¸€è‡´å°±è¡Œ</span>
<span class="n">snapshot</span><span class="p">.</span><span class="n">appendItems</span><span class="p">(</span><span class="n">selectedRecipeIds</span><span class="p">,</span> <span class="n">toSection</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">)</span> <span class="c1">// è¿™é‡Œæ˜¯.mainçš„å…¨é‡æ•°æ®ï¼Œå³å¢åˆ åçš„ç»“æœé›†</span>
<span class="n">recipeListDataSource</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">animatingDifferences</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
</pre></div>
<ul>
<li>å¢åˆ å…¶å®å°±æ˜¯æ–°å»ºä¸€ä¸ªsnapshotï¼Œdatasourceä¼šæ ¹æ®identifiersæ¥æ¯”è¾ƒå“ªäº›å¤šäº†å“ªäº›å°‘äº†ã€‚<ul>
<li>å› ä¸ºåªæ¯”è¾ƒâ€œæ•°é‡â€œï¼Œæ‰€ä»¥åªè¦ç”¨è¿™äº›idå»æ–°å»ºsnapshotå°±å¯ä»¥äº†ï¼Œä¸å­˜åœ¨æŠŠæ—§çš„<strong>retrieve</strong>å‡ºæ¥</li>
</ul>
</li>
</ul>
<h3>Update Existing Items</h3>
<ul>
<li>To handle changes to the properties of an <strong>EXISTING</strong> item, an app retrieves the <strong>current snapshot</strong> from the diffable data source and calls either <a href="https://developer.apple.com/documentation/uikit/nsdiffabledatasourcesnapshot/3804468-reconfigureitems"><code>reconfigureItems(_:)</code></a> or <a href="https://developer.apple.com/documentation/uikit/nsdiffabledatasourcesnapshot/3375783-reloaditems"><code>reloadItems(_:)</code></a> on the snapshot.  -&gt; then <code>Apply</code> to snapshot</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nv">snapshot</span> <span class="p">=</span> <span class="n">recipeListDataSource</span><span class="p">.</span><span class="n">snapshot</span><span class="p">()</span>  <span class="c1">// è¿™æ¬¡æ˜¯retrieveäº†</span>
<span class="c1">// Update the recipe&#39;s data displayed in the collection view.</span>
<span class="n">snapshot</span><span class="p">.</span><span class="n">reconfigureItems</span><span class="p">([</span><span class="n">recipeId</span><span class="p">])</span> <span class="c1">// ä¼ å…¥identifier</span>
<span class="n">recipeListDataSource</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">animatingDifferences</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
</pre></div>
<ul>
<li>the data source invokes its cell provider closure,</li>
</ul>
<h3>Populate Snapshots with Lightweight Data Structures</h3>
<ul>
<li>å¯¹æ•´ä¸ªitemå¯¹è±¡åšHashï¼Œé€‚ç”¨äºå¿«é€Ÿå»ºæ¨¡ï¼Œæˆ–æ•°æ®æºä¸ä¼šå˜æ›´çš„åœºæ™¯ï¼ˆæ¯”å¦‚èœå•ï¼‰ã€‚<ul>
<li>å› ä¸ºitemå¯¹è±¡çš„ä»»ä½•å±æ€§å˜åŒ–éƒ½ä¼šè¢«è®¤ä¸ºæœ‰è¿‡æ”¹åŠ¨å¯¼è‡´é‡ç»˜ï¼Œä¹Ÿä¼šäº§ç”Ÿä¸€äº›å‰¯ä½œç”¨ï¼Œæ¯”å¦‚é‡ç»˜ä¹‹å‰çš„çŠ¶æ€éƒ½ä¼šè¢«æ¸…æ‰ï¼ˆå¦‚selectedï¼‰</li>
</ul>
</li>
<li>å®è·µä¸­ï¼Œä¸ä¼šå¯¹è®¾ç½®datasourceçš„æ—¶å€™ä¸“é—¨ç»™ä¸ªidentifieré›†åˆï¼Œè€Œæ•°æ®æºç”¨åˆ«çš„é›†åˆï¼Œæ¯æ¬¡éƒ½æ˜¯ç”¨identifierä»é›†åˆé‡Œæ‰¾itemè¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯é‡å†™itemçš„hashæ–¹æ³•å’Œequalæ–¹æ³•ï¼Œè®©å…¶åªè§‚å¯Ÿidå­—æ®µ</li>
</ul>
<h3>NSDiffableDataSourceSnapshot</h3>
<ul>
<li>A representation of <strong>the state of the data</strong> in a <code>view</code> at a <strong>specific point in time</strong>.</li>
<li>Diffable data sources use <em>snapshots</em> to provide data for collection views and table views.</li>
<li>You use a snapshot to set up the <strong>initial state</strong> of the data that a view displays, and you use snapshots to reflect <strong>changes to the data</strong> that the view displays.</li>
<li>The data in a snapshot is made up of the <strong>sections</strong> and <strong>items</strong><ul>
<li>Each of your sections and items must have unique identifiers that conform to the <a href="https://developer.apple.com/documentation/swift/hashable"><code>Hashable</code></a> protocol.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1">// Create a snapshot.</span>
<span class="kd">var</span> <span class="nv">snapshot</span> <span class="p">=</span> <span class="bp">NSDiffableDataSourceSnapshot</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">UUID</span><span class="p">&gt;()</span>        

<span class="c1">// Populate the snapshot.</span>
<span class="n">snapshot</span><span class="p">.</span><span class="n">appendSections</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
<span class="n">snapshot</span><span class="p">.</span><span class="n">appendItems</span><span class="p">([</span><span class="n">UUID</span><span class="p">(),</span> <span class="n">UUID</span><span class="p">(),</span> <span class="n">UUID</span><span class="p">()])</span>

<span class="c1">// Apply the snapshot.</span>
<span class="n">dataSource</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">animatingDifferences</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
</pre></div>
<h2>NSDiffableDataSourceSectionSnapshot</h2>
<ul>
<li><p>A representation of <strong>the state of the data</strong> in a <code>layout section</code> at a specific point in time.</p><ul>
<li>æ³¨æ„ä¸<code>dataSourceSnapshot</code>å®šä¹‰çš„åŒºåˆ«</li>
</ul>
</li>
<li><p>A section snapshot represents the data for a single section in a collection view or table view.</p></li>
<li><p>Through a section snapshot, you set up the <strong>initial state</strong> of the data that displays in an individual section of your view, and later <strong>update that data</strong>.</p></li>
<li><p>You can use section snapshots <strong>with</strong> or <strong>instead</strong> of an <a href="https://developer.apple.com/documentation/uikit/nsdiffabledatasourcesnapshot"><code>NSDiffableDataSourceSnapshot</code></a></p></li>
<li><p>Use a section snapshot when you need precise management of the data in a section of your layout</p><ul>
<li>such as when the sections of your layout acquire their data from <strong>different sources</strong>.</li>
<li>ä¸åŒçš„sectionæ¥è‡ªä¸åŒçš„æ•°æ®æºçš„è¯ï¼Œå€¾å‘äºç”¨sectionSnapshot</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">section</span> <span class="k">in</span> <span class="n">Section</span><span class="p">.</span><span class="n">allCases</span> <span class="p">{</span>
    <span class="c1">// Create a section snapshot</span>
    <span class="kd">var</span> <span class="nv">sectionSnapshot</span> <span class="p">=</span> <span class="bp">NSDiffableDataSourceSectionSnapshot</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">&gt;()</span>

    <span class="c1">// Populate the section snapshot</span>
    <span class="n">sectionSnapshot</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Food&quot;</span><span class="p">,</span> <span class="s">&quot;Drinks&quot;</span><span class="p">])</span>
    <span class="n">sectionSnapshot</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;ğŸ&quot;</span><span class="p">,</span> <span class="s">&quot;ğŸ“&quot;</span><span class="p">,</span> <span class="s">&quot;ğŸ¥&quot;</span><span class="p">],</span> <span class="n">to</span><span class="p">:</span> <span class="s">&quot;Food&quot;</span><span class="p">)</span>

    <span class="c1">// Apply the section snapshot</span>
    <span class="n">dataSource</span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sectionSnapshot</span><span class="p">,</span>
                     <span class="n">to</span><span class="p">:</span> <span class="n">section</span><span class="p">,</span>
                     <span class="n">animatingDifferences</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<h1>è‹¹æœCollectionViewæ•™ç¨‹æ–‡æ¡£</h1>
<p><strong>The Layout Object Controls the Visual Presentation</strong></p><ul>
<li>The layout object is solely responsible for determining the <strong>placement and visual styling</strong> of items within the collection view</li>
<li>do not confuse what a layout object does with the <code>layoutSubviews</code> method used to reposition child views inside a parent view.<ul>
<li>A layout object <strong>never</strong> touches the views it manages directly because it <strong>does not actually own</strong> any of those views.</li>
<li>it generates attributes that describe the location, size, and visual appearance of the cells, supplementary views, and decoration views in the collection view.</li>
<li>It is then the job of the collection view to apply those attributes to the actual view objects.</li>
<li>è¿™å°±æ˜¯éœ€è¦æä¾›ä¸¤ä¸ªä»£ç†æ–¹æ³•çš„åŸå› ï¼Œä¸€ä¸ªæä¾›viewï¼Œä¸€ä¸ªæä¾›å¸ƒå±€é…ç½®</li>
</ul>
</li>
</ul>
<p><strong>Transitioning Between Layouts</strong></p><ul>
<li>The easiest way to transition between layouts is by using the <code>setCollectionViewLayout:animated:</code> method.</li>
<li>However, if you require control of the transition or want it to be interactive, use a <code>UICollectionViewTransitionLayout</code> object.</li>
<li>The <code>UICollectionViewTransitionLayout</code> class is a special type of layout that gets installed as the collection viewâ€™s layout object when transitioning to a new layout.<ul>
<li>With a transition layout object, you can have objects follow a <strong>non linear</strong> path, use a different <strong>timing algorithm</strong>, or move according to incoming touch events.</li>
</ul>
</li>
<li>The <code>UICollectionViewLayout</code> class provides <strong>several methods</strong> for <strong>tracking</strong> the transition between layouts.</li>
<li><code>UICollectionViewTransitionLayout</code> objects track the completion of a transition through the <code>transitionProgress</code> property.</li>
<li>As the transition occurs, your code updates this property <strong>periodically</strong> to indicate the completion percentage of the transition.</li>
</ul>
<p>é€šç”¨æµç¨‹ï¼š</p><ol>
<li>Create an instance of the standard class or your own custom class using the <code>initWithCurrentLayout:nextLayout:</code> method.</li>
<li>Communicate the progress of the transition by periodically modifying the <code>transitionProgress</code> property. Do not forget to invalidate the layout using the collection viewâ€™s <code>invalidateLayout</code> method after changing the transitionâ€™s progress.</li>
<li>Implement the <code>collectionView:transitionLayoutForOldLayout:newLayout:</code> method in your collection viewâ€™s delegate and return your transition layout object.</li>
<li>Optionally modify values for your layout using the <code>updateValue:forAnimatedKey:</code> method to indicate changed values relevant to your layout object. The stable value in this case is 0.</li>
</ol>
<p><strong>Customizing the Flow Layout Attributes</strong></p><ul>
<li>Flowlayoutåœ¨ä¸€æ¡çº¿ä¸Šæ’åˆ—å…ƒç´ ï¼Œåˆ°è¾¾äº†è¾¹ç•Œå°±æ¢è¡Œï¼Œæ–°èµ·ä¸€æ¡çº¿</li>
<li>å…ƒç´ å¤§å°å¯ä»¥é€šè¿‡<code>itemSize</code> å±æ€§è®¾ç½®ï¼Œå¦‚æœå¤§å°ä¸åŒï¼Œåˆ™é€šè¿‡<code>[collectionView:layout:sizeForItemAtIndexPath:](https://developer.apple.com/documentation/uikit/uicollectionviewdelegateflowlayout/1617708-collectionview)</code>ä»£ç†æ–¹æ³•è®¾ç½®</li>
<li>ä½†æ˜¯ï¼ŒåŒä¸€è¡Œä¸Šä¸åŒçš„é«˜åº¦çš„cellä¼šå‚ç›´å±…ä¸­æ’åˆ—ï¼Œè¿™ç‚¹è¦æ³¨æ„</li>
<li><code>minimum spacing</code>è®¾ç½®çš„åªæ˜¯åŒä¸€è¡Œå…ƒç´ çš„â€œæœ€å°é—´è·â€ï¼Œå¦‚æœå¸ƒå±€çš„æ—¶å€™ä¸€è¡Œä¸‹ä¸€ä¸ªå…ƒç´ æ”¾ä¸ä¸‹äº†ï¼Œä½†æ˜¯å‰©ä½™çš„ç©ºé—´å¾ˆå¤šï¼Œè¿™ä¸ªä¸€è¡Œçš„å…ƒç´ é—´è·ä¼šæ‹‰å¤§<ul>
<li>è¡Œé—´è·åŒç†ï¼Œæ ¹æ®ä¸Šä¸€æ¡æè¿°ï¼Œå…ƒç´ æ˜¯å‚ç›´å±…ä¸­æ’åˆ—çš„ï¼Œæ‰€ä»¥æœ€å°è¡Œé—´è·è®¾ç½®çš„æ˜¯ä¸Šä¸‹ä¸¤è¡Œé—´æœ€é«˜çš„å…ƒç´ çš„è·ç¦»</li>
</ul>
</li>
</ul>

            </div>
        </article>
        <div class="prism-post-meta col-md-8 offset-md-2">
    <span>walker</span>
    
    <span>/</span>
    <span>
        <a class="category no-link" href="/category/posts/" target="_self">
        posts
        </a>
    </span>
    
    
    <span>/</span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/CollectionView/" target="_self">#CollectionView</a>
    </span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/Diffable%20Datasource/" target="_self">#Diffable Datasource</a>
    </span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/Compositional%20Layout/" target="_self">#Compositional Layout</a>
    </span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/Snapshot/" target="_self">#Snapshot</a>
    </span>
    
    
    
    <span>/</span>
    <span class="leancloud_visitors" id="/archives/collectionview_diffable_datasource/" data-flag-title="Collection View With Diffable Datasource"><span class="leancloud-visitors-count"></span> Views</span>
    
</div>
    </section>

    
<section id="prism__pagination" class="prism-pagination" class="col-md-8 offset-md-2">
    <ul>
        
        <li class="next text-muted">
            <span title="Viewing the newest one."><i class="fa fa-chevron-left" aria-hidden="true"></i>Newer</span>
        </li>
        
        
        <li class="prev">
            <a class="no-link" href="/archives/calayer_mask/" target="_self" title="CALayeråº”ç”¨maskå®ç°ä¸ºæ–‡å­—éƒ¨åˆ†æ¶‚æŠ¹">Older<i class="fa fa-chevron-right" aria-hidden="true"></i></a>
        </li>
        
    </ul>
</section>


    
    <script>
        var initValine = function() {
            new Valine({"enable": true, "el": "#vcomments", "appId": "7tP92LoqK2cggW61DvJmWBo0-gzGzoHsz", "appKey": "iQCtrtlr8eKrQllM03GMESMJ", "visitor": true, "recordIP": true});
        }

    </script>
    <script defer src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js' onload="initValine()"></script>
    <div class="prism-comment-section container" id="prism__comment">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div id="vcomments"></div>
            </div>
        </div>
    </div>
    

</main>

            <footer id="prism__footer">
                <section>
                    <div>
                        <nav class="social-links">
                            <ul><li><a class="no-link" title="Twitter" href="https://twitter.com/walkerwzy" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-twitter"></i></a></li><li><a class="no-link" title="GitHub" href="https://github.com/walkerwzy" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-github"></i></a></li><li><a class="no-link" title="Weibo" href="https://weibo.com/1071696872" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-weibo"></i></a></li></ul>
                        </nav>
                    </div>

                    <section id="prism__external_links">
                        <ul>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://github.com/AlanDecode/Maverick" rel="noopener noreferrer nofollow">Maverick</a>ï¼šğŸ„â€ Go My Own Way.
                                <span>|</span>
                            </li>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://www.imalan.cn" rel="noopener noreferrer nofollow">Triple NULL</a>ï¼šHome page for AlanDecode.
                                <span>|</span>
                            </li>
                            
                        </ul>
                    </section>

                    <div class="copyright">
                        <p class="copyright-text">
                            <span class="brand">walker's code blog</span>
                            <span>Copyright Â© 2022 walker</span>
                        </p>
                        <p class="copyright-text powered-by">
                            | Powered by <a href="https://github.com/AlanDecode/Maverick" class="no-link" target="_blank" rel="noopener noreferrer nofollow">Maverick</a> | Theme <a href="https://github.com/Reedo0910/Maverick-Theme-Prism" target="_blank" class="no-link" rel="noopener noreferrer nofollow">Prism</a>
                        </p>
                    </div>
                    <div class="footer-addon">
                        
                    </div>
                </section>
                <script>
                    var site_build_date = "2019-12-06T12:00+08:00"

                </script>
                <script src="/assets/prism-efa8685153.js"></script>
            </footer>
        </div>
    </div>
    </div>

    <script src="/assets/ExSearch/jquery.min.js"></script>
    <script src="/assets/ExSearch/ExSearch-493cb9cd89.js"></script>

    <!--katex-->
    <link rel="stylesheet" href="/assets/katex.min.css">
    <script defer src="/assets/katex.min.js"></script>
    <script>
        mathOpts = {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "\\[", right: "\\]", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false }
            ]
        };

    </script>
    <script defer src="/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    
</body>

</html>